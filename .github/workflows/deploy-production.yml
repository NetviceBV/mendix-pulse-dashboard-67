name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm_merge:
        description: 'Merge dev to main and deploy to production?'
        required: true
        default: 'no'
        type: choice
        options:
        - 'yes'
        - 'no'

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_merge == 'yes'
    
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Merge dev to main
        run: |
          # Switch to main branch
          git checkout main
          git pull origin main
          
          # Check if there are any differences between dev and main
          if git diff --quiet origin/main origin/dev; then
            echo "â„¹ï¸ No changes between dev and main branches - skipping merge"
            echo "SKIP_SUPABASE=true" >> $GITHUB_ENV
          else
            echo "ðŸ“ Changes detected - proceeding with merge"
            
            # Merge dev into main without committing, excluding client.ts
            git merge origin/dev --no-ff --no-commit || {
              echo "Merge conflict detected, resolving automatically..."
              
              # For workflow file conflicts, use the dev version
              if [ -f .github/workflows/deploy-production.yml ]; then
                git checkout --theirs .github/workflows/deploy-production.yml
              fi
              
              # Mark conflicts as resolved
              git add .
            }
            
            # Restore client.ts from main branch (exclude it from merge)
            git checkout HEAD -- src/integrations/supabase/client.ts 2>/dev/null || echo "client.ts not found, continuing..."
            
            # Check if there are still changes to commit after excluding client.ts
            if git diff --cached --quiet; then
              echo "â„¹ï¸ No changes to commit after excluding client.ts"
              git reset --hard HEAD
              echo "SKIP_SUPABASE=true" >> $GITHUB_ENV
            else
              # Complete the merge commit
              git commit -m "Deploy: Merge dev to main via GitHub Actions (excluding client.ts)"
              
              # Push the merge to main
              git push origin main
              
              echo "âœ… Successfully merged dev to main (excluding client.ts)"
            fi
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Filter migrations for deployment
        if: env.SKIP_SUPABASE != 'true'
        run: |
          echo "ðŸš« Filtering out problematic migration files for deployment..."
          
          # Create temporary migrations directory for deployment
          mkdir -p supabase/migrations_temp
          
          # List of migrations to skip (these won't be deployed)
          SKIP_MIGRATIONS=(
            "20250918074207_0258b852-8862-4150-8cbc-384a9e6c43cb.sql"
            "20250918074237_74ef5b91-7fc2-4c35-934f-684b67292966.sql"
            "20250918125854_5081e749-b6e7-4977-82ab-7da135f383e9.sql"
            "20250918125944_80a00b8f-5d52-43e3-9264-6d96b4c7477e.sql"
            "20250918131943_0588c8dd-9a54-445d-9a85-d761c397d1a3.sql"
            "20250919061724_7b49fea0-2b74-4270-94e9-cccb58cbeb2f.sql"
            "20250919062053_eeac2bf2-282c-4ed4-8315-c36adc38996d.sql"
            "20250919103815_522897f1-3472-4db4-a7ed-4fc3b9a6bf44.sql"
            "20250919110317_351a29f5-b66f-4ecc-8e4f-3de455b747cc.sql"
            "20250919122604_212669c5-f35d-4264-8c33-1d6b5bf1a838.sql"
            "20250920053439_c61950e0-3a0d-414c-b3af-f1e9dd4283d6.sql"
            "20250920053538_752bfdb8-9c94-4aad-8c26-c5217aa652e9.sql"
            "20250922132920_0a9ef401-3c95-4f7f-8a36-a783bc7bafea.sql"
            "20250922141031_777b7076-3302-46a4-997a-da1f7e12e4dd.sql"
            "20250923072701_7eda6fb1-00a5-4fc9-8140-4285e3a7e1d0.sql"
            "20250923121928_d8316df0-0a14-4a42-901d-ab9484ff7a72.sql"
            "20250923142916_725a545f-5a64-4376-b72f-6141d6709635.sql"
            "20250923143352_ee273e9a-f65c-4871-b2f7-c7e8ba0e085b.sql"
          )
          
          # Convert array to associative array for faster lookup
          declare -A skip_map
          for migration in "${SKIP_MIGRATIONS[@]}"; do
            skip_map["$migration"]=1
          done
          
          # Copy only non-skipped migrations to temp directory
          if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
            for file in supabase/migrations/*.sql; do
              filename=$(basename "$file")
              if [[ -z "${skip_map[$filename]}" ]]; then
                echo "  âœ… Including: $filename"
                cp "$file" "supabase/migrations_temp/"
              else
                echo "  ðŸš« Skipping: $filename"
              fi
            done
          fi
          
          # Replace original migrations directory with filtered one
          rm -rf supabase/migrations
          mv supabase/migrations_temp supabase/migrations
          
          echo ""
          echo "ðŸ“‹ Active migrations for deployment:"
          ls -la supabase/migrations/*.sql 2>/dev/null || echo "  â†’ No active migrations found"

      - name: Deploy Supabase changes
        if: env.SKIP_SUPABASE != 'true'
        run: |
          # Show current migration files (after skipping)
          echo "Active migration files after skipping:"
          ls -la supabase/migrations/*.sql 2>/dev/null || echo "No active migration files found"
          
          # Link to remote Supabase project with password
          echo "Linking to Supabase project..."
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --password ${{ secrets.SUPABASE_DB_PASSWORD }}
          
          # Apply database migrations with comprehensive error handling
          echo "Applying database migrations to production..."
          
          # Check if there are any migrations to apply
          if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
            echo "Found active migrations, proceeding with deployment..."
            
            # Apply migrations
            if echo "y" | supabase db push --linked 2>&1 | tee migration_output.log; then
              echo "âœ… All active migrations applied successfully!"
            else
              echo "âŒ Some migrations failed. Check the logs above for specific errors"
              echo "âš ï¸ Deployment will continue with edge functions"
            fi
          else
            echo "â„¹ï¸ No active migration files found - skipping database migration step"
          fi
          
          # Deploy edge functions (run regardless of migration status)
          echo "Deploying edge functions..."
          echo "Checking for edge functions..."
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "Found edge functions directory with content"
            ls -la supabase/functions/
            
            # Deploy all functions with detailed output
            supabase functions deploy --no-verify-jwt --debug || {
              echo "Function deployment failed, trying individual function deployment..."
              
              # Try deploying each function individually
              for func_dir in supabase/functions/*/; do
                if [ -d "$func_dir" ]; then
                  func_name=$(basename "$func_dir")
                  echo "Deploying function: $func_name"
                  supabase functions deploy "$func_name" --no-verify-jwt || echo "Failed to deploy $func_name"
                fi
              done
            }
          else
            echo "No edge functions found in supabase/functions directory"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment Summary
        run: |
          echo "ðŸš€ Deployment Status:"
          if [ "$SKIP_SUPABASE" = "true" ]; then
            echo "â„¹ï¸  No changes detected between dev and main"
            echo "â­ï¸  Skipped Supabase deployment"
            echo "âœ… No action needed - branches are in sync"
          else
            echo "âœ… Merged dev â†’ main"
            echo "ðŸš« Skipped 18 problematic migration files"
            echo "âœ… Applied remaining Supabase migrations"
            echo "âœ… Deployed edge functions"
            echo "ðŸ”„ Vercel will auto-deploy from main branch"
            
            echo ""
            echo "ðŸ“‹ Migration Summary:"
            if ls supabase/migrations/*.sql 1> /dev/null 2>&1; then
              echo "Active migrations applied:"
              ls supabase/migrations/*.sql | while read file; do
                echo "  âœ… $(basename "$file")"
              done
            else
              echo "  â†’ No active migrations were processed"
            fi
            
            echo ""
            echo "Migrations skipped:"
            if ls supabase/migrations/skipped/*.sql 1> /dev/null 2>&1; then
              ls supabase/migrations/skipped/*.sql | while read file; do
                echo "  ðŸš« $(basename "$file")"
              done
            else
              echo "  â†’ No migrations were skipped"
            fi
          fi
